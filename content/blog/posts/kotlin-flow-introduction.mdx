---
title: åˆè¯† Kotlin Flow
date: "2021-04-23T18:37:03.284Z"
---

import LeetCode from "components/LeetCode"

## ä» Sequence è¯´èµ·

Sequence æ˜¯ Kotlin æä¾›çš„ Lazy List å®ç°ã€‚æ¯”å¦‚ä¸‹é¢ä½¿ç”¨ Sequence å®ç°çš„ Fibonacci æ•°åˆ—ï¼š

```kotlin
val fibonacci = sequence {
  var terms = Pair(0L, 1L)
  while (true) {
    ğŸ¹ yield(terms.first)
    terms = Pair(
      terms.second,
      terms.first + terms.second
    )
  }
}
```

### ç»ˆç«¯æ“ä½œç¬¦ï¼ˆterminal operatorï¼‰

æˆ‘ä»¬åœ¨ Sequence builder å—ä¸­ç”¨ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œæºæºä¸æ–­åœ°è®¡ç®—åºåˆ—ä¸­çš„å…ƒç´ ï¼Œå¹¶é€šè¿‡ `yield` å°†å…ƒç´ å‘é€ç»™æ¶ˆè´¹è€…ã€‚Sequence çš„æ¶ˆè´¹è€…å°±æ˜¯æ‰€è°“çš„ç»ˆç«¯æ“ä½œç¬¦ï¼ˆterminal operatorï¼‰,æ¯”å¦‚ `forEach`ï¼Œ`sum` ç­‰ã€‚

```kotlin
fibonacci.take(10).forEach { println(it) }
fibonacci.take(10).sum()
```

ä»¥ `forEach` ä¸ºä¾‹ï¼Œæ¯å½“æˆ‘ä»¬åœ¨ `sequence` å—ä¸­ `yield` ä¸€ä¸ªæ–°å…ƒç´ ï¼Œä¾¿ä¼šå°†è¿™ä¸ªå…ƒç´ å‘é€ç»™ `forEach` å—è¿›è¡Œå¤„ç†ï¼Œç„¶åå†å›åˆ° `sequence` å—ä¸­æ‰§è¡Œåç»­çš„é€»è¾‘ï¼Œè®¡ç®—ä¸‹ä¸€ä¸ªå€¼ã€‚è€Œæ™®é€šçš„ List åˆ™ä¼šå…ˆè®¡ç®—å‡ºæ‰€æœ‰çš„å…ƒç´ å­˜åœ¨å†…å­˜ä¸­ã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ Sequence ä»£è¡¨æ— é™å…ƒç´ çš„åºåˆ—ã€‚ä½†æ˜¯åœ¨æ¶ˆè´¹æ•°æ®çš„æ—¶å€™å¿…é¡»ä½¿ç”¨ `take` ä¸­é—´æ“ä½œç¬¦é™åˆ¶æ¶ˆè´¹çš„æ•°é‡ã€‚

### ä¸­é—´æ“ä½œç¬¦ï¼ˆintermediate operatorï¼‰

Sequence å’Œ List ä¸€æ ·æœ‰ `map` ã€`filter` è¿™äº›ä¸­é—´æ“ä½œç¬¦ã€‚æ¯åœ¨ List ä¸Šè°ƒç”¨ä¸€æ¬¡ä¸­é—´æ“ä½œç¬¦éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ Listï¼›è€Œåœ¨ Sequence ä¸Šè°ƒç”¨æ“ä½œç¬¦ç›¸å½“äºæ„å»ºä¸€ä¸ªæ•°æ®çš„ç®¡é“ã€‚ä¸€ä¸ªå…ƒç´ è¢« `yield` å‡ºæ¥åï¼Œå®ƒä¼šç©¿è¿‡è¿™äº›å®šä¹‰å¥½çš„æ•°æ®ç®¡é“ï¼Œåˆ°è¾¾ç»ˆç«¯æ¶ˆè´¹è€…ã€‚

å‡è®¾æ²¡æœ‰ç»ˆç«¯æ¶ˆè´¹è€…ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç›¸å½“äºæ­å¥½äº†æ•°æ®çš„ç®¡é“ï¼Œä½†æ˜¯åœ¨è¿è¡Œæ—¶ Sequence builder ä¸­çš„ä»£ç å¹¶ä¸ä¼šè¿è¡Œã€‚

ä¸‹é¢è¿™ä¸ªå°ä¾‹å­ä¼šè¾“å‡ºå­—ç¬¦ä¸² `"AaBbCc"`

```kotlin
sequence {
  yield("A".also { print(it) })
  yield("B".also { print(it) })
  yield("C".also { print(it) })
}.forEach {
  print(it.toLowerCase())
}
```

### åº”ç”¨æ¡ˆä¾‹ï¼šæ‰¾å‡ºç¬¬ä¸€ä¸ªé null å±æ€§

```kotlin
class Feedback(
  val rate: Int,
  val message: String?
)

val feedbacks = listOf(
  Feedback(4, null),
  Feedback(4, "Cool and clear function"),
  Feedback(3, null),
  Feedback(1, "Hey, it's too much"),
)
```
å‡è®¾æˆ‘ä»¬æƒ³è¦æ‰¾å‡ºç¬¬ä¸€ä¸ªä¸ä¸º null çš„ `Feedback.message`ï¼Œ å³ `"Cool and clear function"`ã€‚
æœ‰ä¸‹é¢å‡ ç§æ–¹å¼ï¼š

```kotlin
// æ–¹æ³•1ï¼šç”Ÿæˆä¸€ä¸ªä¸­é—´ Collection
feedbacks.mapNotNull { it.name }.firstOrNull()

// æ–¹æ³•2ï¼šè½¬æ¢æˆ Sequence
feedbacks
  .asSequence() // highlight-line
  .mapNotNull { it.name }.firstOrNull()

// æ–¹æ³•3ï¼šKotlin 1.5 æ ‡å‡†åº“æ–¹æ³•
feedbacks.firstNotNullOfOrNull { it.name }
```
å¦‚æœé›†åˆå…ƒç´ éå¸¸å¤šï¼Œæˆ–è€…åˆéœ€è¦ç»è¿‡å¾ˆå¤šæ“ä½œç¬¦å˜æ¢ï¼Œè¿™æ ·æ¯æ¬¡å˜æ¢éƒ½åˆ›å»ºä¸€ä¸ªæ–°çš„é›†åˆå­˜å‚¨ä¸­é—´ç»“æœä¼šæœ‰äº›æµªè´¹ã€‚
è¿™æ ·çš„åœºæ™¯ä½¿ç”¨ Sequence ä¼šæ›´å¥½ä¸€äº›ã€‚

[[tip | âœ¨]]
| è¿™ä¸ªä¾‹å­æ‘˜è‡ª [Kotlin 1.5.0-RC Released: Changes to the Standard and Test Libraries](https://blog.jetbrains.com/kotlin/2021/04/kotlin-1-5-0-rc-released/)
| å¤§å®¶è§‰å¾— `firstNotNullOfNull` è¿™ä¸ªæ–¹æ³•æ€ä¹ˆæ ·ï¼Ÿ

### åº”ç”¨æ¡ˆä¾‹ï¼šæ‰å¹³åŒ–åµŒå¥—åˆ—è¡¨è¿­ä»£å™¨

<LeetCode.ProblemCard id={341} thisSite={true} />

è¿™é“åŠ›æ‰£é¢˜ç›®æ˜¯è¿™æ ·ï¼šç»™ä½ ä¸€ä¸ªåµŒå¥—çš„æ•´å‹åˆ—è¡¨ã€‚è¯·ä½ è®¾è®¡ä¸€ä¸ªè¿­ä»£å™¨ï¼Œä½¿å…¶èƒ½å¤Ÿéå†è¿™ä¸ªæ•´å‹åˆ—è¡¨ä¸­çš„æ‰€æœ‰æ•´æ•°ã€‚æ•´å‹åˆ—è¡¨ç”±è¿™ä¸ªæ¥å£è¡¨ç¤ºï¼š

```kotlin
interface NestedInteger {
  fun isInteger(): Boolean
  fun getInteger(): Int?
  fun getList(): List<NestedInteer>?
}
```

åˆ—è¡¨ä¸­çš„æ¯ä¸€é¡¹æˆ–è€…ä¸ºä¸€ä¸ªæ•´æ•°ï¼Œæˆ–è€…æ˜¯å¦ä¸€ä¸ªåˆ—è¡¨ã€‚å…¶ä¸­åˆ—è¡¨çš„å…ƒç´ ä¹Ÿå¯èƒ½æ˜¯æ•´æ•°æˆ–æ˜¯å…¶ä»–åˆ—è¡¨ã€‚ ç¤ºä¾‹ï¼š

```text
è¾“å…¥: [[1,1],2,[1,1]]
è¾“å‡º: [1,1,2,1,1]
```

***

å¦‚æœå°†æ‰€æœ‰å…ƒç´ å­˜è¿›ä¸€ä¸ª Listï¼Œé‚£ä¹ˆå¯ä»¥ç”¨é€’å½’è½»æ¾è§£å†³è¿™ä¸ªé—®é¢˜ï¼š

```kotlin
fun flatten(nestedList: List<NestedInteger>): List<Int> {
  val ans = mutableListOf()

  fun walk(list: List<NestedInteger>) {
    for (item in list) {
      if (item.isInteger()) ans += item
      else walk(item.getList())
    }
  }

  walk(nestedList)

  return ans
}
```

æ‹¿åˆ° List ä»¥åå¯ä»¥è½¬æˆä¸€ä¸ªè¿­ä»£å™¨ã€‚ä½†æ˜¯è¿­ä»£å™¨åº”è¯¥æ˜¯ã€Œæ‡’ã€çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æ¶ˆè´¹è€…ä¸€è¾¹æ¶ˆè´¹æ•°æ®ï¼Œè¿­ä»£å™¨ä¸€è¾¹éå†æ•°æ®æºã€‚è¿™æ ·çš„å¥½å¤„åŒ…æ‹¬ï¼š

- å¦‚æœæ¶ˆè´¹è€…åªéœ€è¦å‰å‡ æ¡æ•°æ®ï¼Œè€Œæ•°æ®æºåˆå¾ˆå¤§ï¼Œé‚£ä¹ˆé¢„å…ˆè®¡ç®—å‡ºæ•´ä¸ª List åšäº†å¾ˆå¤šæ— ç”¨åŠŸã€‚
- æ¶ˆè´¹è€…ä¸ç”¨ç­‰å¾…æ•´ä¸ª List è®¡ç®—å®Œæˆåæ‰è¿›è¡Œä¸‹ä¸€æ­¥å¤„ç†ã€‚é€šè¿‡å¹¶å‘å¯ä»¥åŠ å¿«æ•´ä¸ªæ•°æ®å¤„ç†æµç¨‹çš„é€Ÿåº¦ã€‚

ä½†æ˜¯è¿™æ ·æˆ‘ä»¬å°±ä¸æ–¹ä¾¿ç›´æ¥é€’å½’ï¼Œéœ€è¦è‡ªå·±æ‰‹åŠ¨ç»´æŠ¤ä¸€ä¸ªæ ˆï¼ŒåŸæœ¬ç®€å•çš„ä»£ç å˜å¾—å¤æ‚äº†è®¸å¤šï¼ˆå¯ä»¥åœ¨[è¿™é‡Œ](/leetcode/flatten-nested-list-iterator/#solution)æŸ¥çœ‹å®Œæ•´ä»£ç ï¼‰ã€‚

å€ŸåŠ© Sequenceï¼Œæˆ‘ä»¬å¯ä»¥ç”¨é€’å½’çš„ç®—æ³•å®ç°æ‡’çš„è¿­ä»£å™¨ï¼š

```kotlin
// ä¸ºäº†è¿›è¡Œé€’å½’éœ€è¦å°è£…å‡ºä¸€ä¸ªå‡½æ•°
suspend tailrec fun SequenceScope<Int>.walk(
  list: List<NestedInteger>
) {
  for (item in list) {
    if (item.isInteger()) yield(item.getInteger())
    else walk(item.getList())
  }
}

sequence { walk(nestedList) }.iterator() // é¢˜ç›®æ‰€æ±‚
```

[[tip | ğŸ’¡]]
| æˆ–è®¸ä¼šæƒ³åˆ°ï¼Œå¯ä»¥ç»™ `walk` å‡½æ•°ä¼ ä¸€ä¸ªå›è°ƒï¼Œè¿™æ ·ä¹Ÿèƒ½å®ç°è¾¹éå†è¾¹æ¶ˆè´¹çš„æ•ˆæœã€‚å¯ä»¥ç†è§£æˆ Sequence å°±æ˜¯å¯¹è¿™ä¸€æ–¹å¼çš„å°è£…ã€‚è¿˜è®°å¾— suspend æœ¬è´¨ä¸Šæ˜¯å›è°ƒã€‚
| Sequence builder æ˜¯ä¸€ä¸ªï¼ˆå—é™çš„ï¼‰suspend å—ï¼Œè€Œ `yield` æ˜¯ suspend å‡½æ•°ã€‚

## Flowï¼šå¯ä»¥ suspend çš„ Sequence

ä¸Šé¢çš„ä¾‹å­ä¸­æ•°æ®æµé‡Œåªæœ‰çº¯è®¡ç®—ã€‚å®é™…åœºæ™¯ä¸­æˆ‘ä»¬å¯èƒ½éœ€è¦åœ¨ä¸­é—´æˆ–è€…ç»ˆç«¯æ“ä½œç¬¦åšä¸€äº›è€—æ—¶çš„æ“ä½œï¼ˆå‡è®¾éƒ½å°è£…æˆäº† suspend å‡½æ•°ï¼‰ï¼Œæ¯”å¦‚è°ƒæ¥å£ã€ä»æ•°æ®åº“è¯»å†™æ•°æ®ï¼š

```kotlin
suspend fun search(string: String) {/**/}
suspend fun saveToDB(string: String) {/**/}

// âŒ æ— æ³•ç¼–è¯‘
// ä¸èƒ½åœ¨ Sequence çš„æ“ä½œç¬¦ä¸­è°ƒç”¨ suspend å‡½æ•°
sequenceOf("foo", "bar")
  .map { search(it) } // è°ƒç”¨è¿œç¨‹ api
  .forEach { saveToDB(it) } // å­˜è‡³æ•°æ®åº“
```

ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä»¬å¸Œæœ›ä¾æ¬¡è°ƒç”¨æ¥å£æœç´¢ `"foo"` å’Œ `"bar"` æ‹¿åˆ°æœç´¢ç»“æœåå­˜å…¥æ•°æ®åº“ï¼Œå³æŒ‰ç…§è¿™ä¸ªé¡ºåºï¼š

- yield `"foo"`
- search `"foo"`
- saveToDB `"foo"`
- yield `"bar"`
- search `"bar"`
- saveToDB `"bar"`

ç„¶è€Œï¼ŒSequence çš„æ“ä½œç¬¦åªèƒ½ä¼ å…¥å¸¸è§„ï¼ˆé suspendï¼‰çš„å—ï¼Œæ— æ³•åœ¨å…¶ä¸­è°ƒç”¨ suspend å‡½æ•°ã€‚

äºæ˜¯æˆ‘ä»¬æœ‰äº† Flowï¼š

```kotlin
suspend fun search(string: String) {/**/}
suspend fun saveToDB(string: String) {/**/}

scope.launch {
	flowOf("foo", "bar")
    .map { ğŸ¹ search(it) } // è°ƒç”¨è¿œç¨‹ api
 ğŸ¹ .collect { ğŸ¹ saveToDB(it )} // å­˜è‡³æ•°æ®åº“
}
```

Flow å’Œ Kotlin åç¨‹çš„è®¾è®¡ä¸€æ ·é»˜è®¤æ˜¯é¡ºåºæ‰§è¡Œçš„ï¼Œæ²¡æœ‰å¹¶å‘ã€‚ä¸Šé¢çš„ä¾‹å­ä»æ‰§è¡Œé¡ºåºä¸Šç­‰åŒä¸‹é¢è¿™ä¸ªå¾ªç¯ï¼š

```kotlin
for (item in listOf("foo", "bar")) {
  val result = ğŸ¹ search(item)
  ğŸ¹ saveToDB(result)
}
```

`collect` ä¸ºä»£è¡¨çš„ç»ˆç«¯æ“ä½œç¬¦æ˜¯ suspend å‡½æ•°ã€‚å› æ­¤ï¼Œå¯¹ Flow è¿›è¡Œæ¶ˆè´¹å¿…é¡»æœ‰ä¸€ä¸ª CoroutineScopeã€‚è€Œ Sequence çš„ç»ˆç«¯æ“ä½œç¬¦éƒ½åªæ˜¯æ™®é€šå‡½æ•°ã€‚

[[tip | ğŸ¤”]]
| Flow è®©æˆ‘ä»¬å¯ä»¥å¯¹æ•°æ®æµä¸­çš„æ•°æ®åº”ç”¨ suspend å‡½æ•°ï¼Œè€Œæ‰€æœ‰ suspend å‡½æ•°å¿…é¡»åœ¨æŸä¸ª CoroutineScope ä¸­æ‰§è¡Œã€‚è¿™äº› suspend çš„å—é»˜è®¤å°±è¿è¡Œåœ¨ collect çš„ CoroutineScope ä¸­ã€‚

å®é™…ä¸Šå’Œ Sequence ä¸€æ ·ï¼ŒFlow çš„ç»ˆç«¯æ“ä½œç¬¦æ‰æ˜¯é©±åŠ¨æ•´ä¸ªæ•°æ®æµçš„â€œåŸåŠ¨åŠ›â€ã€‚å¦‚æœæ²¡æœ‰ç»ˆç«¯æ“ä½œç¬¦ï¼Œåªæœ‰è‹¥å¹² mapã€filterï¼Œç›¸å½“äºåªæ­å»ºäº†ä¸€ä¸ªæ•°æ®ç®¡é“ï¼ŒFlow builder ä¸­çš„ä»£ç ä¸ä¼šè¿è¡Œï¼Œæ•°æ®ä¸ä¼šæµåŠ¨ã€‚ä¸€ç§æœ‰ç›Šçš„ç†è§£æ˜¯æŠŠè¿™ç§ flow çš„å®šä¹‰ç±»æ¯”æˆå‡½æ•°å®šä¹‰ï¼ŒæŠŠç»ˆç«¯æ“ä½œç¬¦ç±»æ¯”æˆï¼ˆsuspendï¼‰å‡½æ•°è°ƒç”¨ï¼š

```kotlin
val myFlow: Flow<Int> = flow {/**/}.map {/**/ }
```

- åªæœ‰åœ¨ `myFlow` ä¸Šè°ƒç”¨ç»ˆç«¯æ“ä½œç¬¦çš„æ—¶å€™ï¼Œ`flow {}` å—ä»¥åŠ `map {}` ä¸­çš„ä»£ç æ‰ä¼šè¿è¡Œï¼Œæ•°æ®æ‰ä¼šæµåŠ¨ã€‚
- å¦‚æœåœ¨ `myFlow` ä¸Šè°ƒç”¨ä¸¤æ¬¡ `collect` ï¼Œå°±å¥½æ¯”åŒä¸€ä¸ªå‡½æ•°è°ƒç”¨ä¸¤æ¬¡ã€‚
- `myFlow` å†…éƒ¨å«æœ‰ suspend å—ï¼Œæœ¬èº«ä¹Ÿåº”å½“çœ‹æˆ suspend å‡½æ•°ï¼Œåœ¨è°ƒç”¨çš„æ—¶å€™å¿…é¡»æä¾›ä¸€ä¸ª CoroutineScopeã€‚

Flow å€ŸåŠ©è¯­è¨€å±‚é¢çš„ suspend æœºåˆ¶å®ç°å¼‚æ­¥ï¼Œè€Œå¯¹æ¯”ä¹‹ä¸‹ RxJava éœ€è¦åœ¨æµä¸­çš„æ•°æ®ç±»å‹ä½“ç°å¼‚æ­¥ã€‚æ¯”å¦‚ä½¿ç”¨ RxJava åšç½‘ç»œè¯·æ±‚ï¼š

```kotlin
fun callSearchApi(string: String)
  : Observable<SeachResult> // highlight-line

Observable.just("foo", "bar")
  .flatMap { callSearchApi(it) } // highlight-line
  .subscribe { println(it) }
```

æ³¨æ„åˆ° `callSearchApi` çš„è¿”å›ç»“æœéœ€è¦å¥—åœ¨ä¸€ä¸ª `Observable` é‡Œï¼ŒåŒæ—¶æ•°æ®æµä¸­çš„å˜æ¢éœ€è¦ä½¿ç”¨ `flatMap`ã€‚è€Œä½¿ç”¨åç¨‹å’Œ Flow çš„è¯ï¼Œå¼‚æ­¥å‡½æ•°è¿”å›å€¼ä¸éœ€è¦æˆ´ä»»ä½•å¥—å­ï¼Œæ•°æ®æµå˜æ¢å¯ä»¥ç›´æ¥ä½¿ç”¨ `map`ã€‚

```kotlin
suspend fun callSearchApi(string: String): SeachResult

scope.launch {
  flowOf("foo", "bar")
    .map { callSearchApi(it) }
    .collect { println(it) }
}

// æˆ–è€…ä½¿ç”¨ `launchIn`ï¼Œå‡å°‘åµŒå¥—
flowOf("foo", "bar")
  .map { callSearchApi(it) }
  .onEach { println(it) }
  .launchIn(scope)
```

## ä¸€ä¸ªç©å…· Flow

Kotlin Flow çš„è®¾è®¡å’Œå®ç°ååˆ†ç®€æ´ä¼˜é›…ï¼Œæˆ‘ä»¬ä¸å¦¨è¯•ç€å®ç°ä¸€ä¸ªæç®€çš„ç©å…·ç‰ˆæœ¬ã€‚

`Flow` interface åªæœ‰ä¸€ä¸ª `collect` æ–¹æ³•ï¼Œæ¥å—ä¸€ä¸ª `FlowCollector` çš„å‚æ•°ã€‚ `FlowCollector` æ˜¯ä¸€ä¸ªå…¸å‹çš„ä»£è¡¨æ¶ˆè´¹è€…çš„ interfaceï¼ˆæ¯”å¦‚ `Comparator`, åŒæ ·ä¹Ÿæ˜¯ä½¿ç”¨ `<in T>`ï¼‰ã€‚

```kotlin
interface Flow<out T> {
  suspend fun collect(collector: FlowCollector<T>)
}

interface FlowCollector<in T> {
	suspend fun emit(value: T)
}
```

è¿™ä¸ª `collect` æ–¹æ³•å¯ä»¥çœ‹æˆè”ç³»ååº”å¼æ•°æ®æµä¸Šä¸‹æ¸¸çš„çº½å¸¦ã€‚

- ä¸Šæ¸¸æ•°æ®æºï¼Œé€šè¿‡ `this` è®¿é—®ï¼›
- ä¸‹æ¸¸æ¶ˆè´¹è€…ï¼Œé€šè¿‡ `collector` è®¿é—®ã€‚

### å®ç° collect

```kotlin
class MyFlow: Flow<T> {
  override suspend fun collect(collector: FlowCollector<T>) {
    TODO()
  }
}
```

å½“æˆ‘ä»¬ `collect` çš„æ—¶å€™éœ€è¦å°†æ•°æ®å‘é€ç»™ `FlowCollector` è¿›è¡Œæ¶ˆè´¹ï¼Œé‚£ä¹ˆè¿™ä¸ªæ•°æ®ä»å“ªé‡Œæ¥å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ç”¨ Flow builder æ¥åˆ›å»º flowï¼š

```java
flow {
  ğŸ¹ emit(1)
  ğŸ¹ emit(2)
  ğŸ¹ emit(3)
} ğŸ¹.collect {
  println(it)
}
```

å’¦ï¼Œæ³¨æ„åˆ° `emit` äº†å—ï¼Ÿä¸æ˜¯åˆ«äººï¼Œæ­£æ˜¯ `FlowCollector.emit` æ–¹æ³•ã€‚æ‰€ä»¥è¿™ä¸ª `flow` builder å‡½æ•°æ¥æ”¶äº†ä¸€ä¸ªä»¥ `FlowCollector` ä¸º receiver çš„å—ã€‚è¿™ä¸ª `FlowCollector` ä»å“ªå„¿æ¥ï¼Ÿ`Flow.collect` çš„æ—¶å€™ä¼ è¿›æ¥ã€‚

è¿™æ ·å½¢æˆäº†ä¸€ä¸ªé—­ç¯ï¼šæˆ‘ä»¬åœ¨ `flow` builder å‡½æ•°çš„ suspend å—é‡Œé¢è°ƒç”¨çš„ `emit` æ˜¯è°ƒç”¨åœ¨å°†æ¥ collect Flow æ—¶å€™å‡ºç°çš„ä¸‹æ¸¸æ¶ˆè´¹è€…èº«ä¸Šã€‚è¿™ä½“ç°äº† Flow ã€Œæ‡’ã€çš„æ€§è´¨ï¼šæˆ‘ä»¬åœ¨åˆ›å»ºä¸€ä¸ª Flow çš„æ—¶å€™ä¸ä¼šç«‹é©¬è®¡ç®—å‡ºæ•°æ®ï¼Œè€Œæ˜¯ä¼ å…¥ä¸€ä¸ª suspend å‡½æ•°å—ï¼Œç­‰ Flow collect çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ‹¿åˆ°äº†æ¶ˆè´¹è€… `FlowCollector`ï¼Œå¹¶ä»¥æ­¤ä¸º receiver è°ƒç”¨äº‹å…ˆå­˜å¥½çš„ suspend å—ã€‚è¿™ä¸€è®¾è®¡å°¤å…¶å·§å¦™åœ°åˆ©ç”¨äº† Kotlin å¸¦ receiver lambda çš„ç‰¹æ€§ã€‚

æŠŠä¸Šé¢çš„åˆ†æè½å®åˆ°ä»£ç é‡Œï¼Œå°±å¾—åˆ°äº†æˆ‘ä»¬çš„ç©å…·å®ç°ï¼š

```kotlin
class FlowImpl(
  private val builder: suspend FlowCollector<T>.() -> Unit
): Flow<T> {
  override suspend fun collect(collector: FlowCollector<T>)
    = collector.builder()
}
```

ä¸ºäº†æ–¹ä¾¿è°ƒç”¨æ–¹èƒ½å¤Ÿä½¿ç”¨ `collect {...}` çš„å½¢å¼æ¶ˆè´¹æ•°æ®ï¼Œå¯ä»¥å®šä¹‰ä¸€ä¸ªæ‰©å±•å‡½æ•°ï¼š

```kotlin
// åŸå°ä¸åŠ¨çš„åç¨‹åº“å®ç°
public suspend inline fun <T> Flow<T>.collect(
  crossinline action: suspend (value: T) -> Unit
): Unit = collect(object : FlowCollector<T> {
  override suspend fun emit(value: T) = action(value)
})
```

### ä¸­é—´æ“ä½œç¬¦

ä¸­é—´æ“ä½œç¬¦éœ€è¦ collect ä¸Šæ¸¸çš„ Flowï¼Œå¯¹ä¸Šæ¸¸æ•°æ®è¿›è¡Œå˜æ¢ï¼Œå¹¶å°†å˜æ¢åçš„æ•°æ®å‘é€ç»™ä¸€ä¸ªæ–°çš„ flowã€‚æ¯”å¦‚æˆ‘ä»¬å¯ä»¥è¿™æ ·å®ç° map æ“ä½œç¬¦ï¼š

```kotlin
fun <T, R> Flow<T>.map(block: suspend (value: T) -> R) =
  FlowImpl<R> {
    collect { emit(block(it)) }
  }
```

å’Œ Sequenceã€Iterable ä¸€æ ·ï¼ŒFlow çš„ä¸­é—´æ“ä½œç¬¦éƒ½æ˜¯æ‰©å±•å‡½æ•°ã€‚è¿™ä½¿å¾— Flow çš„ interface å¯ä»¥åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œä¿æŒç²¾ç®€ï¼ŒåŒæ—¶ä¹Ÿæ–¹ä¾¿ç”¨æˆ·è‡ªå®šä¹‰æ“ä½œç¬¦ã€‚æˆ‘ä»¬åœ¨è°ƒç”¨è‡ªå®šä¹‰æ“ä½œç¬¦çš„æ—¶å€™å’Œæ ‡å‡†åº“è‡ªå¸¦çš„æ“ä½œç¬¦æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œä¸åƒ RxJava é‚£æ ·éœ€è¦å€ŸåŠ© `transform` æˆ–è€… `lift` è¿™ç§é¢å¤–çš„ APIï¼ˆå‚è€ƒ [Implementing Custom Operators in RxJava](https://www.baeldung.com/rxjava-custom-operators)ï¼‰ã€‚

ã€Œå¯¹ä¸Šæ¸¸æ•°æ®è¿›è¡Œå˜æ¢ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„ Flowã€è¿™ä¸ªæ¨¡å¼éå¸¸å¸¸è§ï¼Œäºæ˜¯ Kotlin åç¨‹åº“æä¾›äº†ä¸ª transform æ–¹æ³•ã€‚map å’Œ filter ç­‰å¾ˆå¤šæ“ä½œç¬¦çš„å®ç°éƒ½ä½¿ç”¨äº†è¿™ä¸ªæ–¹æ³•ã€‚åœ¨å®šä¹‰è‡ªå·±çš„è¿ç®—ç¬¦çš„æ—¶å€™ä¹Ÿå»ºè®®ä½¿ç”¨ã€‚

```kotlin
// Kotlin åç¨‹åº“å†… Flow.map çš„å®ç°
public inline fun <T, R> Flow<T>.map(
  crossinline transform: suspend (value: T) -> R
): Flow<R> = transform { value ->
   return@transform emit(transform(value)) // highlight-line
}
```

### å®Œæ•´ä»£ç 

```kotlin
class FlowImpl<T>(
  private val builder: suspend FlowCollector<T>.() -> Unit
) : Flow<T> {
  override suspend fun collect(collector: FlowCollector<T>) = collector.builder()
}

fun <T, R> Flow<T>.map(block: suspend (value: T) -> R) = FlowImpl<R> {
  collect { emit(block(it)) }
}

fun <T> Flow<T>.filter(block: suspend (value: T) -> Boolean) = FlowImpl<T> {
  collect { if (block(it)) emit(it) }
}

suspend fun main() = FlowImpl<Int> { emit(1); emit(2) }
  .map { it * it }
  .filter {
    ğŸ¹ delay(1000)
    it % 2 == 0
  }
  ğŸ¹ .collect { println("collected $it") }
```

å¯ä»¥çœ‹åˆ°ï¼Œå€ŸåŠ© Kotlin å·²æœ‰çš„ suspend åŸºç¡€è®¾æ–½ï¼Œå®ç°ä¸€ä¸ªæ”¯æŒå¼‚æ­¥çš„ååº”å¼æ•°æ®æµä¸è¿‡ä¸¤ä¸‰è¡Œã€‚å®é™…ä¸Šï¼ŒKotlin åç¨‹åº“çš„ Flow å®ç°ç»è¿‡æŠ½ä¸å‰¥èŒ§ï¼Œæ ¸å¿ƒä»£ç å’Œæˆ‘ä»¬çš„ç©å…·å®ç°å¹¶æ²¡æœ‰å¤ªå¤šåŒºåˆ«ï¼Œä½†æä¾›äº†ä¸¤ä¸ªé¢å¤–çš„ä¿è¯ï¼šä¸Šä¸‹æ–‡ä¿å­˜ï¼ˆContext preservationï¼‰å’Œå¼‚å¸¸é€æ˜ï¼ˆException transparencyï¼‰ã€‚

[[tip | ğŸ”—]]
| å…³äº suspend å‡½æ•°ï¼Œæ¬¢è¿é˜…è¯»[ã€Šç†è§£ Kotlin çš„ suspend å‡½æ•°ã€‹](/posts/understanding-kotlin-suspend-functions/)ã€‚

## Flow çš„é¢å¤–ä¿è¯

### ä¸Šä¸‹æ–‡ä¿å­˜ï¼ˆContext preservationï¼‰

å¦‚æœ collect çš„å—è¿è¡Œåœ¨ä¸»çº¿ç¨‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªå—é‡Œæ›´æ–° UIï¼Œè¿™æ˜¯å®¢æˆ·ç«¯çš„å¸¸è§åœºæ™¯ã€‚RxJava å¯ä»¥ç”¨ `observeOn` å’Œ `subscribeOn` æ“ä½œç¬¦åˆ‡æ¢çº¿ç¨‹ã€‚ä½†æ˜¯æˆ‘ä»¬æ‹¿åˆ°ä¸€ä¸ª Observable ä»¥åï¼Œåªçœ‹å‡½æ•°ç­¾åæ— æ³•ç¡®å®šæ¶ˆè´¹è€…ä¼šåœ¨å“ªä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œæ‰€ä»¥ä¸€èˆ¬ä¼šæ‰‹åŠ¨è°ƒä¸€æ¬¡ `observeOn(mainThread)` ã€‚
æœ‰çš„æ—¶å€™é¡¹ç›®é‡Œä¼šåœ¨å…¨å±€çš„ä½ç½®ï¼ˆæ¯”å¦‚ Retrofit çš„ call adapterï¼‰ç»Ÿä¸€åŠ ä¸Šäº†åˆ‡æ¢è‡³ä¸»çº¿ç¨‹çš„æ“ä½œï¼Œä½†æ˜¯åœ¨å®é™…è°ƒç”¨çš„æ—¶å€™ä¼šä¸æ”¾å¿ƒï¼Œæˆ–è€…ä¹ æƒ¯æ€§åœ°æ¥ä¸€å¥ `observeOn(mainThread)` ï¼Œçº¿ç¨‹åˆ‡äº†åˆåˆ‡ã€‚

Kotlin åç¨‹ä¸­åœ¨ CoroutineContext ä¸­è®°å½•çº¿ç¨‹çš„è°ƒåº¦ä¿¡æ¯ã€‚Flow æä¾›äº†ã€Œä¸Šä¸‹æ–‡ä¿å­˜ Context preservationã€è¿™ä¸€ä¿è¯ï¼šFlow åœ¨è¿è¡Œæ—¶ç¡®ä¿ä¸Šæ¸¸ä¸èƒ½æ”¹å˜ä¸‹æ¸¸çš„ contextã€‚æ¢å¥è¯è¯´æ¶ˆè´¹ Flow çš„çº¿ç¨‹å–å†³äºè°ƒç”¨ collect çš„ CoroutineContextã€‚åœ¨å“ªé‡Œ collect å°±åœ¨å“ªé‡Œæ‰§è¡Œï¼Œæ‰€è§å³æ‰€å¾—ã€‚å‡è®¾æˆ‘ä»¬ä»æŸä¸ª API æ‹¿åˆ°äº†ä¸€ä¸ª flowï¼š

```kotlin
fun magicFlow(): Flow<String> = {/**/}

lifecycleScope.launch {
  magicFlow().collect {
    // ä¸€å®šåœ¨ä¸»çº¿ç¨‹æ‰§è¡Œ
    uiBinding.label.text = it
  }
}
```

è¿™ä¸ª `magicFlow` å¯èƒ½æœ‰ä¸€éƒ¨åˆ†åˆ‡æ¢åˆ°äº†æŸä¸ªåå°çº¿ç¨‹ï¼Œä½†å¯¹äºè°ƒç”¨æ–¹æ¥è¯´è¿™äº›éƒ½æ˜¯ `magicFlow` çš„å†…éƒ¨å®ç°ç»†èŠ‚ï¼Œæ— é¡»å…³å¿ƒã€‚è°ƒç”¨æ–¹å› ä¸ºè¦æ›´æ–° UIï¼Œå¸Œæœ›åœ¨ä¸»çº¿ç¨‹æ¶ˆè´¹æ•°æ®ã€‚ç”±äºæˆ‘ä»¬åœ¨ androidx æä¾›çš„ `LifecycleScope` ä¸Šå¼€å¯çš„åç¨‹å†…è°ƒç”¨ suspend `collect` æ–¹æ³•ï¼Œè€Œ LifecycleScope çš„ CoroutineContext æŒ‡å®šäº†ä¸»çº¿ç¨‹ä¸ºåç¨‹è°ƒåº¦å™¨ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç¡®å®š collect çš„å—ä¼šåœ¨ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œä¸ä¼šå—åˆ°ä¸Šæ¸¸çš„å½±å“ã€‚

è¿™ä¸€è®¾è®¡å’Œ Kotlin åç¨‹ä¸€è„‰ç›¸æ‰¿ã€‚suspend å‡½æ•°åœ¨å“ªä¸ªçº¿ç¨‹æ‰§è¡Œå´å†³äºè°ƒç”¨ suspend å‡½æ•°çš„ CoroutineScopeï¼Œå®Œå…¨åœ¨è°ƒç”¨æ–¹çš„æ§åˆ¶ä¹‹å†…ã€‚suspend å‡½æ•°å†…éƒ¨å¯èƒ½ä¼šåˆ‡åˆ°å…¶ä»–çº¿ç¨‹ï¼ˆæ¯”å¦‚ IO åœºæ™¯ä¸‹éœ€è¦åˆ‡æ¢çº¿ç¨‹é¿å…é˜»å¡ä¸»çº¿ç¨‹ï¼‰ï¼Œä½†è°ƒç”¨æ–¹æ— é¡»å…³å¿ƒã€‚çº¿ç¨‹åˆ‡æ¢çš„ç»†èŠ‚å¯¹ Flow çš„è°ƒç”¨æ–¹æ¥è¯´ä¹Ÿå‡ ä¹æ˜¯é€æ˜çš„ã€‚å¤§éƒ¨åˆ†å®¢æˆ·ç«¯åœºæ™¯ç›´æ¥åœ¨ä¸»çº¿ç¨‹ `collect` Flow å³å¯ã€‚

å›çœ‹æˆ‘ä»¬çš„ç©å…·å®ç°å¹¶æ²¡æœ‰æä¾›è¿™æ ·çš„ä¿è¯ï¼š

```kotlin
fun magicFlow() = FlowImpl<Int> {
  withContext(Dispatchers.IO) { // highlight-line
    emit(1) // highlight-line
  }
}

suspend fun main() {
  magicFlow().collect {
    // ä¼šè°ƒåº¦åˆ° Dispatchers.IO è¿è¡Œ
    println(coroutineContext)
  }
}
```

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åœ¨åˆ‡æ¢äº†åç¨‹è°ƒåº¦å™¨çš„å—ä¸­ emit æ•°æ®ã€‚å›æƒ³ä¸€ä¸‹ï¼Œemit å®é™…ä¸Šå°±æ˜¯åœ¨è°ƒç”¨ collect é‡Œçš„ lambdaã€‚è¿™æ ·ä¸Šæ¸¸ flow å†…éƒ¨å®ç°â€œå·å·åœ°â€æŠŠä¸‹æ¸¸è°ƒç”¨æ–¹çš„ CoroutineContext æ¢æ‰äº†ï¼Œè°ƒç”¨æ–¹éš¾ä»¥ä¸€çœ¼å°±çŸ¥é“çœ¼å‰æ¶ˆè´¹ flow çš„ä»£ç ä¼šåœ¨å“ªä¸ª CoroutineContext æ‰§è¡Œã€‚

æ‰€ä»¥ï¼ŒKotlin åç¨‹åº“çš„ Flow å®ç°ä¼šæ£€æŸ¥ emit å’Œ collect åœ¨åŒä¸€ä¸ªåç¨‹é‡Œæ‰§è¡Œï¼Œå¦åˆ™ä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼š

```
Exception in thread "main" java.lang.IllegalStateException: Flow invariant is violated
```

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ**Flow ç¦æ­¢çš„æ˜¯åœ¨ä¸åŒçš„åç¨‹ emit æ•°æ®**ï¼Œå¹¶ä¸æ˜¯è¯´ Flow å—ä¸­ä¸èƒ½åˆ‡æ¢ Contextã€‚æ¯”å¦‚ä¸‹é¢çš„ä¾‹å­æ˜¯å¯ä»¥çš„ï¼š

```kotlin
suspend fun main() {
  val f = flow {
    emit(1)
    val value = withContext(Dispatchers.IO) { 2 }
    emit(value)
  }

  f.collect {
    println(it)
  }
}
```

æŒ‰ç…§ Kotlin åç¨‹çš„è®¾è®¡ï¼Œè¿™æ ·çš„å†™æ³•å¿…ç„¶å¯ä»¥ã€‚æˆ‘ä»¬å¯ä»¥æƒ³è±¡æŠŠ `withContext` å—è¿™ä¸ªè¡¨è¾¾å¼æŠ½æˆä¸€ä¸ª suspend å‡½æ•°ï¼Œåœ¨ Flow builder ä¸­è°ƒç”¨ã€‚suspend å‡½æ•°å†…éƒ¨åˆ‡æ¢ Context çš„æ“ä½œå¯¹å¤–éƒ¨è°ƒç”¨æ–¹é€æ˜ã€‚

### å¼‚å¸¸é€æ˜ï¼ˆException transparencyï¼‰

Flow å¦ä¸€ä¸ªä¿è¯æ˜¯å¼‚å¸¸é€æ˜ã€‚æ ¹æ®ç¬”è€…ç›®å‰çš„è§‚ç‚¹ï¼Œä¸å¤ªæ¨èåœ¨ä½¿ç”¨ Kotlin åç¨‹çš„æ—¶å€™æ‰”å¼‚å¸¸ã€‚å¯¹è¿™ä¸€éƒ¨åˆ†æ„Ÿå…´è¶£çš„è¯å¯ä»¥æŸ¥é˜…å®˜æ–¹æ–‡æ¡£ã€‚

[Asynchronous Flow - Exception Transparency](https://kotlinlang.org/docs/flow.html#exception-transparency)

## Flow åœ¨ Android å®¢æˆ·ç«¯çš„åº”ç”¨

æ€»ç»“ä¸€ä¸‹ï¼Œç›¸æ¯” RxJavaï¼ŒFlow çš„ä¼˜ç‚¹åŒ…æ‹¬ï¼š

- ä¾æ‰˜è¯­è¨€å±‚é¢çš„ suspend åŸºç¡€è®¾æ–½ï¼Œè®¾è®¡å’Œå®ç°éƒ½æ›´åŠ ç®€æ´ä¼˜é›…ï¼Œæ“ä½œç¬¦ç»„åˆæ€§æ›´å¼ºï¼›
- æ‰©å±•å‡½æ•°å®šä¹‰æ“ä½œç¬¦ï¼Œè‡ªå®šä¹‰æ“ä½œç¬¦çš„è°ƒç”¨æ–¹å¼å’Œåç¨‹åº“è‡ªå¸¦ Flow æ“ä½œç¬¦ä¸€è‡´ï¼›
- æä¾›äº†ä¸Šä¸‹æ–‡ä¿å­˜ç­‰é¢å¤–ä¿è¯ï¼Œå»¶ç»­åç¨‹çš„è®¾è®¡æ€æƒ³ï¼Œä½¿å¾—çº¿ç¨‹åˆ‡æ¢çš„ç»†èŠ‚å‡ ä¹å®Œå…¨é€æ˜ã€‚

ç„¶è€Œåœ¨ Android å®¢æˆ·ç«¯ï¼Œå¤§éƒ¨åˆ†å¼‚æ­¥çš„åœºæ™¯ä½¿ç”¨ Kotlin åç¨‹ï¼ˆsuspend å‡½æ•°ï¼‰å°±è¶³å¤Ÿäº†ã€‚
RxJava åœ¨ Android ç¤¾åŒºéå¸¸æµè¡Œï¼Œä¸»è¦è¿˜æ˜¯è§£å†³çº¿ç¨‹åˆ‡æ¢éº»çƒ¦çš„é—®é¢˜ï¼Œè€Œè¿™ä¸€åœºæ™¯ Kotlin åç¨‹å·²ç»èƒ½å¤Ÿéå¸¸ä¼˜é›…åœ°è§£å†³ã€‚

ç›®å‰ï¼ŒAndroid Jetpack è¶Šæ¥è¶Šå¤š API ä½¿ç”¨ Flowï¼Œæ¯”å¦‚ DataStoreã€Roomã€Paging 3 ç­‰ã€‚å»ºç«‹å¯¹ Flow æ­£ç¡®çš„ç†è§£å¯ä»¥æ›´å¥½åœ°ä½¿ç”¨è¿™äº›åº“ã€‚

æ­¤å¤–ï¼ŒRxAndroid æŠŠå¸¸è§çš„ Android ç»„ä»¶å°è£…æˆæ•°æ®æºï¼Œæ–¹ä¾¿æˆ‘ä»¬åšå‡½æ•°ååº”å¼ç¼–ç¨‹ï¼Œåœ¨ä¸€äº›ç®€å•çš„åœºæ™¯ä¸‹ä½¿ç”¨æ•ˆæœæ¯”è¾ƒå¥½ï¼Œæ¯”å¦‚å¯¹ç”¨æˆ·çš„è¾“å…¥è¿›è¡Œé˜²æŠ–ï¼ˆdebounceï¼‰ï¼Œç„¶åè°ƒç”¨å¼‚æ­¥æ¥å£ã€‚Flow å¯ä»¥ä½¿ç”¨ [ReactiveCircus/FlowBinding](https://github.com/ReactiveCircus/FlowBinding)ã€‚

```kotlin
lifecycleScope.launch {
  binding.editText.textChanges()
    .debounce(300)
    .map {
      ğŸ¹ callSearchApi(it)
    }
    .collectLatest {
      updateUi(it)
    }
}
```

## å‚è€ƒèµ„æ–™

[KotlinConf 2019: Asynchronous Data Streams with Kotlin Flow by Roman Elizarov](https://www.youtube.com/watch?v=tYcqn48SMT8)
