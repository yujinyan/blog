---
title: ç»™å‰ç«¯åŒå­¦çš„ Java åç«¯å¼€å‘ä»‹ç»
date: "2022-09-14T23:00:03.284Z"
---


[[tip|ğŸš§]]
| å°šæœªå®Œæˆ - Work In Progress

## å…³äº Java è¯­è¨€

The Java language is â€¦

- Compiled: éœ€è¦ç”¨ javac å°† .java æºä»£ç æ–‡ä»¶ç¼–è¯‘æˆ .class å­—èŠ‚ç æ–‡ä»¶
- Object-oriented: é¢å‘å¯¹è±¡

### Hello World

```java
// HelloWorld.java
class HelloWorld {
    public static void main(String[] args) {
        System.out.println("Hello World!");
    }
}
```

```shell
$ javac HelloWorld.java
$ java HelloWorld
```

### é¢å‘å¯¹è±¡ Object-oriented

Java:
```java
@Value
public class Person implements A {
    String name;

    String introduce() {
        return "I'm " + name;
    }

    // Run this programmin with `java Person`
    public static void main(String[] args) {
        A harry = new Person("Harry");
        String a = "abc";

        System.out.println(harry.introduce());
    }
}

interface A {
  String introduce();
}
```

TypeScript:
```tsx
type Person = {
  name: string
}

const harry = {
  name: "Harry"
}

function introduce(person: Person) {
  return `I'm ${person.name}`
}

console.log(harry)
```


### Duck typing vs. Nominative typing

[[tip | ğŸ”‘]]
| Java å’Œ TypeScript ç±»å‹ç³»ç»Ÿçš„åŒºåˆ«

**Nominative typing**: an object is of a given type *if it is declared to be* (or if a type's association with the object is inferred through mechanisms such as object inheritance).

**Duck typing**: an object is of a given type if it has all methods and properties required by that type.

## Java è™šæ‹Ÿæœº

### The runtime environment

JVM is the **runtime** for Java. (JVM â†’ Java, Node.js â†’ JavaScript).

Androidâ€™s Dalvik and its replacement Android Runtime (ART) are other widely used Java runtimes.

[[tip | ğŸ”‘]]
| Difference between `java HelloWorld` and `node hello.js`

interpreting vs. compiling

- V8 compiles JavaScript source code to native machine codeÂ [at runtime](https://en.wikipedia.org/wiki/Just-in-time_compilation). As of 2016, it also includes Ignition, aÂ [bytecode interpreter](https://en.wikipedia.org/wiki/Bytecode_interpreter). [(Wikipedia - Node.js)](https://en.wikipedia.org/wiki/Node.js)
- JVM interprets bytecode produced by javac. It also uses JIT (just-in-time compilation) to translate part of Java bytecode into native machine code.

### Other major JVM languages

- Kotlinï¼šæ”¹è‰¯ç‰ˆ Javaã€Android å¼€å‘é¦–é€‰è¯­è¨€
  - NPE
  - static by default
  - fix mutable by default

  ```kotlin
  val foo: String = ""
  var bar: Int = 1
  fun sayHi(): String = TODO()
    ```

  ```ts
  const foo = ""
  let bar: number = 1
  function sayHi() {
   // ...
  }
    ```

- Groovyï¼šå¼±ç±»å‹ã€åŠ¨æ€ã€Gradle
- Scalaï¼šå­¦é™¢æ´¾ã€å‡½æ•°å¼ã€å¤§æ•°æ®ã€Flink
- Clojureï¼šåŠ¨æ€ã€å‡½æ•°å¼ã€Lisp

## Spring Boot

### å¿«é€Ÿä¸Šæ‰‹

åœ¨ [Spring Initializr](https://start.spring.io/) åˆ›å»ºä¸€ä¸ªé¡¹ç›®è„šæ‰‹æ¶ï¼Œå¯¼å…¥ IDE å³å¯

### JSON åºåˆ—åŒ–ã€ååºåˆ—åŒ–

[[tip| ğŸ”‘]]
| å‰ç«¯ä¼ ç»™åç«¯çš„ JSON å­—ç¬¦ä¸²æ˜¯å¦‚ä½•å˜æˆå¯¹è±¡çš„ï¼Ÿ

JavaScript:
```js
const c = JSON.stringify({id: 1, title: "hi"})
JSON.parse(c)
```

ç±»æ¯” Javaï¼š
```java
@Value
class Campaign {
  int id;
  String title;
}

ObjectMapper objectMapper = new ObjectMapper();

Campaign campaign = new Campaign(1, "hi");
String json = objectMapper.writeValueToString(campaign); // highlight-line
Campaign c = objectMapper.readValueFromString(json, Campaign.class); // highlight-line
```

[[tip | ğŸ”]]
| ååºåˆ—åŒ–çš„æ—¶å€™éœ€è¦æŒ‡å®šå¾—åˆ°å¯¹è±¡çš„ç±»å‹

æœ‰å¤šç§ JSON åºåˆ—åŒ–/ååºåˆ—åŒ–çš„åº“ï¼Œå¦‚ Jacksonã€Gson ç­‰ã€‚Java åç«¯é¡¹ç›®æ¨èç”¨ Jacksonï¼ˆä¹Ÿæ˜¯ Spring Boot é»˜è®¤çš„ JSON åº“ï¼‰ã€‚

å¸¸è§æ•°æ®ç±»å‹å¯¹åº”å…³ç³»ï¼š

|     | Java ç±»å‹                   | JS ç±»å‹                      |
|-----|---------------------------|----------------------------|
| æ—¥æœŸ  | `java.time.ZonedDateTime` | åŸç”Ÿ Dateã€moment.jsã€day.js * |
| æšä¸¾  | enum                      | string                     |


`LocalDateTime` vs `ZonedDateTime`
- `ZonedDateTime` å¸¦æœ‰æ—¶åŒº
- `LocalDateTime` ä¸å¸¦æ—¶åŒº

```shell
$ node
Welcome to Node.js v16.17.0.
Type ".help" for more information.
> new Date()
2022-09-13T02:10:14.100Z
```

JS çš„ `Date` å¸¦æ—¶åŒºï¼Œæ‰€ä»¥ç›´æ¥å¯¹åº” Java çš„ `ZonedDateTime`

## æ³¨è§£ Annotation

æ·»åŠ å…ƒä¿¡æ¯ï¼ˆMetadataï¼‰


| ç”¨é€”    | ä¸»è¦åœºæ™¯         | ä¾‹                        |
|-------|--------------|--------------------------|
| ç¼–è¯‘å™¨æç¤º | ç»™ç¼–è¯‘å™¨é¢å¤–ä¿¡æ¯     | `@Override`              |
| ç¼–è¯‘æ—¶å¤„ç† | ä»£ç ç”Ÿæˆ         | Lombok                   |
| è¿è¡Œæ—¶å¤„ç† | è·¯ç”±é…ç½®ã€Bean æ ¡éªŒ | JSR-303: Bean Validation |

### ç¼–è¯‘å™¨æç¤º

```java
public class OverrideDemo {

    static class Shape {
        String name() {
            return "Shape";
        }
    }

    @Override // highlight-line
    static class Circle extends Shape {
        String name() {
            return "Circle";
        }
    }
}
```

### ç¼–è¯‘æ—¶å¤„ç†

[Project Lombok](https://projectlombok.org/features/)

æˆ‘ç”¨å¾—æœ€å¤šçš„ï¼š`@Value`ï¼Œç”¨äº immutable data class

JDK 17 çš„è¯å¯ä»¥ç›´æ¥ç”¨ record

### è¿è¡Œæ—¶å¤„ç†

```java
import lombok.Value;
import org.hibernate.validator.HibernateValidatorFactory;

import javax.validation.ConstraintViolation;
import javax.validation.Validation;
import javax.validation.Validator;
import javax.validation.ValidatorFactory;
import javax.validation.constraints.Min;
import java.util.Set;

/**
 * https://hibernate.org/validator/documentation/getting-started/
 */
public class BeanValidationDemo {

    @Value
    static class Article {
        @Min(5)
        String title;
    }

    public static void main(String[] args) {
        ValidatorFactory factory = Validation.buildDefaultValidatorFactory();
        Validator validator = factory.getValidator();
        Set<ConstraintViolation<Article>> violations = validator.validate(new Article("Hi"));
        System.out.println(violations);
    }
}
```

```java
import lombok.Value;
import lombok.extern.slf4j.Slf4j;

import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.reflect.Field;

@Slf4j
public class RuntimeDemo {
    @Retention(RetentionPolicy.RUNTIME)
    @interface Range {
        int min();
        int max();
    }

    @Value
    static class Article {
        @Range(min = 1, max = 100)
        String title;
    }

    public static void main(String[] args) {
        Article article = new Article("Hello World");
        Field[] fields = article.getClass().getDeclaredFields();
        for (Field field : fields) {
            Range range = field.getAnnotation(Range.class); // highlight-line
            if (range != null) {
                log.info("range: min is {}, max is {}, field {}", range.min(), range.max(), field);
            }
        }
    }
}
```

## å¹¶å‘ç¼–ç¨‹

### çº¿ç¨‹ API

```java
public class ThreadDemo {
    @SneakyThrows
    public static void main(String[] args) {
        Thread thread = new Thread(() -> {
            try {
                Thread.sleep(1000L);
                System.out.printf("Inside %s%n", Thread.currentThread().getName());
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
        });
        thread.start();
        thread.join();
    }
}
```

### çº¿ç¨‹æ± 

```java
public class ThreadPoolDemo {

    private static final ExecutorService POOL = Executors.newCachedThreadPool();

    @SneakyThrows
    static String writeFile() {
        Thread.sleep(1000);
        return "file.csv";
    }

    @SneakyThrows
    public static void main(String[] args) {
        Future<String> filename = POOL.submit(ThreadPoolDemo::writeFile);
        System.out.println(filename.get());
    }
}
```

### Request Per Thread

ä¼ ç»Ÿ Spring MVC ä½¿ç”¨çš„æ˜¯ä¸€ä¸ª http è¯·æ±‚å¯¹åº”ä¸€ä¸ªçº¿ç¨‹çš„æ¨¡å‹

```java
@RestController
class NaiveCounterDemoController {
    // çº¿ç¨‹ä¸å®‰å…¨çš„ç¤ºèŒƒ
    private int counter = 0;

    @PostMapping("/inc")
    public void inc() {
        counter++;
    }

    @GetMapping("/get")
    public int get() {
        return counter;
    }
}
```

### Shared Mutable State

[[fig | å¹¶å‘åŠ è®¡æ•°å™¨çš„é—®é¢˜]]
| ![Race condition between two clients concurrently incrementing a counter](./counter-race.png)

è§£å†³æ–¹æ³•ï¼š
- Thread-safe data structures: `AtomicInteger` ï¼ˆcounter åœºæ™¯é¦–é€‰ï¼‰
- Mutual exclusion
- Thread confinement

[Shared Mutable State and Concurrency in Kotlin](https://kotlinlang.org/docs/shared-mutable-state-and-concurrency.html)

## æ•°æ®åº“æŒä¹…åŒ–

- Raw SQL / Template Engine: MyBatis XML
- SQL DSL: JOOQ

```java
SELECT AUTHOR.FIRST_NAME, AUTHOR.LAST_NAME, COUNT(*)
FROM AUTHOR
JOIN BOOK ON AUTHOR.ID = BOOK.AUTHOR_ID
WHERE BOOK.LANGUAGE = 'DE'
AND BOOK.PUBLISHED > DATE '2008-01-01'
GROUP BY AUTHOR.FIRST_NAME, AUTHOR.LAST_NAME
HAVING COUNT(*) > 5
ORDER BY AUTHOR.LAST_NAME ASC NULLS FIRST
LIMIT 2
OFFSET 1
```

```java
create.select(AUTHOR.FIRST_NAME, AUTHOR.LAST_NAME, count())
      .from(AUTHOR)
      .join(BOOK).on(AUTHOR.ID.equal(BOOK.AUTHOR_ID))
      .where(BOOK.LANGUAGE.eq("DE"))
      .and(BOOK.PUBLISHED.gt(date("2008-01-01")))
      .groupBy(AUTHOR.FIRST_NAME, AUTHOR.LAST_NAME)
      .having(count().gt(5))
      .orderBy(AUTHOR.LAST_NAME.asc().nullsFirst())
      .limit(2)
      .offset(1)
```

- ORM: Hibernate / prisma.io
