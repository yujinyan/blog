---
title: ç»™å‰ç«¯åŒå­¦çš„ Java åç«¯å¼€å‘ä»‹ç»
date: "2022-09-14T23:00:03.284Z"
---

import PullQuote from "@/components/PullQuote"

<PullQuote emoji="ğŸš§">
  å°šæœªå®Œæˆ - Work In Progress
</PullQuote>

## å…³äº Java è¯­è¨€

The Java language is â€¦

- Compiled: éœ€è¦ç”¨ javac å°† .java æºä»£ç æ–‡ä»¶ç¼–è¯‘æˆ .class å­—èŠ‚ç æ–‡ä»¶
- Object-oriented: é¢å‘å¯¹è±¡

### Hello World

```java
// HelloWorld.java
class HelloWorld {
    public static void main(String[] args) {
        System.out.println("Hello World!");
    }
}
```

```shell
$ javac HelloWorld.java
$ java HelloWorld
```

### é¢å‘å¯¹è±¡ Object-oriented

Java:
```java
@Value
public class Person implements A {
    String name;

    String introduce() {
        return "I'm " + name;
    }

    // Run this programmin with `java Person`
    public static void main(String[] args) {
        A harry = new Person("Harry");
        String a = "abc";

        System.out.println(harry.introduce());
    }
}

interface A {
  String introduce();
}
```

### Duck typing vs. Nominative typing

TypeScript:
```tsx
type Person = {
  name: string
}

const harry = {
  name: "Harry"
}

function introduce(person: Person) {
  return `I'm ${person.name}`
}

console.log(introduce(harry))
```

<PullQuote emoji="ğŸ”‘">
  Java å’Œ TypeScript ç±»å‹ç³»ç»Ÿçš„åŒºåˆ«
</PullQuote>

**Nominative typing**: å¯¹è±¡ç±»å‹ã€ç»§æ‰¿å…³ç³»å¿…é¡»æ˜¾å¼å£°æ˜. An object is of a given type *if it is declared to be* (or if a type's association with the object is inferred through mechanisms such as object inheritance).

**Duck typing**: å¯¹è±¡æ»¡è¶³ç±»å‹çš„çº¦æŸæ¡ä»¶ï¼ˆå«æœ‰ç‰¹å®šå±æ€§æˆ–æ–¹æ³•ï¼‰å³å¯. An object is of a given type if it has all methods and properties required by that type.

<PullQuote emoji="ğŸ¦†">
  èƒ½åƒé¸­å­ä¸€æ ·å«çš„å¯¹è±¡å°±æ˜¯ä¸€åªé¸­å­
</PullQuote>

## Java è™šæ‹Ÿæœº

### The runtime environment

JVM æ˜¯ Java çš„è¿è¡Œæ—¶ï¼Œç±»ä¼¼ Node.js ï¼ˆæˆ–è€…è¯´ V8ï¼‰ å’Œ JavaScript ä¹‹é—´çš„å…³ç³»

å…¶ä»–å¹¿æ³›ä½¿ç”¨çš„ Java è¿è¡Œæ—¶ï¼š
- Android çš„ Dalvik ä»¥åŠåæ¥çš„ Android Runtime (ART)

<PullQuote emoji="ğŸ”‘">
  Difference between `java HelloWorld` and `node hello.js`
</PullQuote>

interpreting vs. compiling

- V8 compiles JavaScript source code to native machine code [at runtime](https://en.wikipedia.org/wiki/Just-in-time_compilation). As of 2016, it also includes Ignition, a [bytecode interpreter](https://en.wikipedia.org/wiki/Bytecode_interpreter). [(Wikipedia - Node.js)](https://en.wikipedia.org/wiki/Node.js)
- JVM interprets bytecode produced by javac. It also uses JIT (just-in-time compilation) to translate part of Java bytecode into native machine code.

### å…¶ä»–ä¸»æµ JVM è¯­è¨€

- Kotlinï¼šæ”¹è‰¯ç‰ˆ Javaã€Android å¼€å‘é¦–é€‰è¯­è¨€
- Groovyï¼šå¼±ç±»å‹ã€åŠ¨æ€ã€Gradle
- Scalaï¼šå­¦é™¢æ´¾ã€å‡½æ•°å¼ã€å¤§æ•°æ®ã€Flink
- Clojureï¼šåŠ¨æ€ã€å‡½æ•°å¼ã€Lisp

## Spring Boot

### å¿«é€Ÿä¸Šæ‰‹

åœ¨ [Spring Initializr](https://start.spring.io/) åˆ›å»ºä¸€ä¸ªé¡¹ç›®è„šæ‰‹æ¶ï¼Œå¯¼å…¥ IDE å³å¯

### JSON åºåˆ—åŒ–ã€ååºåˆ—åŒ–

<PullQuote emoji="ğŸ”‘">
  å‰ç«¯ä¼ ç»™åç«¯çš„ JSON å­—ç¬¦ä¸²æ˜¯å¦‚ä½•å˜æˆå¯¹è±¡çš„ï¼Ÿ
</PullQuote>

JavaScript:
```js
const c = JSON.stringify({id: 1, title: "hi"})
JSON.parse(c)
```

ç±»æ¯” Javaï¼š
```java
@Value
class Campaign {
  int id;
  String title;
}

ObjectMapper objectMapper = new ObjectMapper();

Campaign campaign = new Campaign(1, "hi");
String json = objectMapper.writeValueToString(campaign); // highlight-line
Campaign c = objectMapper.readValueFromString(json, Campaign.class); // highlight-line
```

<PullQuote emoji="ğŸ”">
  ä¸åŒäº JavaScriptï¼ŒJava åœ¨ååºåˆ—åŒ–æˆå¯¹è±¡çš„æ—¶å€™éœ€è¦æŒ‡å®šç±»å‹
</PullQuote>

æœ‰å¤šç§ JSON åºåˆ—åŒ–/ååºåˆ—åŒ–çš„åº“ï¼Œå¦‚ Jacksonã€Gson ç­‰ã€‚Java åç«¯é¡¹ç›®æ¨èç”¨ Jacksonï¼ˆä¹Ÿæ˜¯ Spring Boot é»˜è®¤çš„ JSON åº“ï¼‰ã€‚

å¸¸è§æ•°æ®ç±»å‹å¯¹åº”å…³ç³»ï¼š

|     | Java ç±»å‹                   | JS ç±»å‹                      |
|-----|---------------------------|----------------------------|
| æ—¥æœŸ  | `java.time.ZonedDateTime` | åŸç”Ÿ Dateã€moment.jsã€day.js * |
| æšä¸¾  | enum                      | string                     |


`LocalDateTime` vs `ZonedDateTime`
- `ZonedDateTime` å¸¦æœ‰æ—¶åŒº
- `LocalDateTime` ä¸å¸¦æ—¶åŒº

```shell
$ node
Welcome to Node.js v16.17.0.
Type ".help" for more information.
> new Date()
2022-09-13T02:10:14.100Z
```

JS çš„ `Date` å¸¦æ—¶åŒºï¼Œæ‰€ä»¥ç›´æ¥å¯¹åº” Java çš„ `ZonedDateTime`

## æ³¨è§£ Annotation

Java çš„æ³¨è§£å’Œ JavaScript çš„ Decorator è¯­æ³•ç›¸ä¼¼ï¼Œä½†è¯­ä¹‰ä¸åŒã€‚Java æ³¨è§£çš„ä½œç”¨æ˜¯ç»™ classã€æ–¹æ³•ã€å­—æ®µç­‰æ·»åŠ å…ƒä¿¡æ¯ï¼ˆMetadataï¼‰ã€‚

| ç”¨é€”    | ä¸»è¦åœºæ™¯         | ä¾‹                        |
|-------|--------------|--------------------------|
| ç¼–è¯‘å™¨æç¤º | ç»™ç¼–è¯‘å™¨é¢å¤–ä¿¡æ¯     | `@Override`              |
| ç¼–è¯‘æ—¶å¤„ç† | ä»£ç ç”Ÿæˆ         | Lombok                   |
| è¿è¡Œæ—¶å¤„ç† | è·¯ç”±é…ç½®ã€Bean æ ¡éªŒ | JSR-303: Bean Validation |

### ç¼–è¯‘å™¨æç¤º

```java
public class OverrideDemo {

    static class Shape {
        String name() {
            return "Shape";
        }
    }

    static class Circle extends Shape {
        @Override // highlight-line
        String name() { // highlight-line
            return "Circle";
        }
    }
}
```

å‡è®¾ `Circle#name` æ–¹æ³•æ³¨è§£äº† `@Override`ï¼Œä½†æ˜¯å®é™…ä¸Šå¹¶æ²¡æœ‰è¦†å†™çˆ¶ç±»çš„ä»»ä½•æ–¹æ³•ï¼Œä¼šæŠ¥ç¼–è¯‘é”™è¯¯ã€‚`@Override` æ³¨è§£æ˜¯å¯é€‰çš„ï¼Œ
ç»™ç¼–è¯‘å™¨é¢å¤–çš„æç¤ºä¿¡æ¯ã€‚

### ç¼–è¯‘æ—¶å¤„ç†

[Project Lombok](https://projectlombok.org/features/) æ˜¯ä¸€ä¸ªåˆ©ç”¨ Java çš„æ³¨è§£å¤„ç†å™¨æœºåˆ¶ï¼Œ
é€šè¿‡åœ¨ç¼–è¯‘æœŸç”Ÿæˆä»£ç å¸®åŠ©æˆ‘ä»¬å‡å°‘æ ·æ¿ä»£ç ï¼ˆboilerplateï¼‰çš„å·¥å…·ç±»åº“ã€‚

æˆ‘ç”¨å¾—æœ€å¤šçš„ï¼š`@Value`ï¼Œç”¨äº immutable data class

JDK 17 çš„è¯å¯ä»¥ç›´æ¥ç”¨ record

### è¿è¡Œæ—¶å¤„ç†

ä¹Ÿå¯ä»¥åœ¨è¿è¡Œæ—¶è·å–æ³¨è§£ä¸Šæ ‡æ³¨çš„ä¿¡æ¯ã€‚å¸¸è§çš„ Bean æ•°æ®æ ¡éªŒï¼ˆJSR-303ï¼‰ã€Spring MVC åŸºäºæ³¨è§£çš„è·¯ç”±é…ç½®éƒ½æ˜¯é‡‡ç”¨è¿™ç§æœºåˆ¶ã€‚

åœ¨ Spring Boot é¡¹ç›®ä¸­ä½¿ç”¨ Hibernate çš„ Bean æ ¡éªŒåº“ï¼š

```groovy
implementation 'org.springframework.boot:spring-boot-starter-validation'
```

API Demo:

```java
import lombok.Value;
import org.hibernate.validator.HibernateValidatorFactory;

import javax.validation.ConstraintViolation;
import javax.validation.Validation;
import javax.validation.Validator;
import javax.validation.ValidatorFactory;
import javax.validation.constraints.Min;
import java.util.Set;

/**
 * https://hibernate.org/validator/documentation/getting-started/
 */
public class BeanValidationDemo {

    @Value
    static class Article {
        @Min(5)
        String title;
    }

    public static void main(String[] args) {
        ValidatorFactory factory = Validation.buildDefaultValidatorFactory();
        Validator validator = factory.getValidator();
        Set<ConstraintViolation<Article>> violations =
            validator.validate(new Article("Hi")); // highlight-line
        System.out.println(violations);
    }
}
```

å‡è®¾æˆ‘ä»¬è‡ªå·±å†™ä¸€ä¸ªè¿™æ ·çš„åº“ï¼š

```java
import lombok.Value;
import lombok.extern.slf4j.Slf4j;

import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.reflect.Field;

@Slf4j
public class RuntimeDemo {
    // è‡ªå®šä¹‰æ³¨è§£ï¼Œéœ€è¦ä¿ç•™åˆ°è¿è¡Œæ—¶
    @Retention(RetentionPolicy.RUNTIME) // highlight-line
    @interface Range { // highlight-line
        int min();
        int max();
    }

    @Value
    static class Article {
        @Range(min = 1, max = 100)
        String title;
    }

    public static void main(String[] args) {
        Article article = new Article("Hello World");
        Field[] fields = article.getClass().getDeclaredFields();
        for (Field field : fields) {
            // è·å– Range ç±»å‹çš„æ³¨è§£
            Range range = field.getAnnotation(Range.class); // highlight-line
            if (range != null) {
                log.info("range: min is {}, max is {}, field {}",
                    range.min(),
                    range.max(),
                    field);
            }
        }
    }
}
```

## å¹¶å‘ç¼–ç¨‹

### çº¿ç¨‹ API

```java
public class ThreadDemo {
    @SneakyThrows
    public static void main(String[] args) {
        Thread aThread = new Thread(() -> {
            try {
                Thread.sleep(1000L);
                System.out.printf("Inside %s%n",
                    Thread.currentThread().getName()); // highlight-line
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
        });
        // è°ƒç”¨ start æ–¹æ³•åï¼ŒaThread å¼€å§‹è¿è¡Œ
        // aThread å’Œ main çº¿ç¨‹å¹¶å‘
        aThread.start();
        System.out.printf("Inside %s%n",
            Thread.currentThread().getName()); // highlight-line
        // ç­‰å¾… aThread æ‰§è¡Œå®Œæˆ
        aThread.join();
    }
}
```

JVM çº¿ç¨‹å¯¹åº”æ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼Œæ˜¯æ¯”è¾ƒæ˜‚è´µçš„èµ„æºã€‚å®é™…å¼€å‘ä¸­å‡ ä¹ä¸ä¼šç›´æ¥ `new Thread`ï¼Œè€Œæ˜¯ä½¿ç”¨çº¿ç¨‹æ± åšå¤šä»»åŠ¡å¹¶å‘ã€‚

<PullQuote emoji="ğŸš€">
  [JEP 425](https://openjdk.org/jeps/425) å°†ä¸º JVM å¸¦æ¥è™šæ‹Ÿçº¿ç¨‹ï¼Œå³åœ¨ä¸€ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ä¸Šå¤ç”¨å¤šä¸ªè™šæ‹Ÿçº¿ç¨‹ï¼Œä»è€Œæä¾›åº”ç”¨ååé‡ã€‚
  å…³äºè™šæ‹Ÿçº¿ç¨‹æ¨èé˜…è¯» Brian Goetz çš„ [Virtual Threads: New Foundations for High-Scale Java Applications](https://www.infoq.com/articles/java-virtual-threads/)
</PullQuote>

### çº¿ç¨‹æ± 

```java
public class ThreadPoolDemo {

    // åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± 
    private static final ExecutorService POOL =
        Executors.newCachedThreadPool();

    @SneakyThrows
    static String writeFile() {
        Thread.sleep(1000);
        return "file.csv";
    }

    @SneakyThrows
    public static void main(String[] args) {
        Future<String> filename = POOL.submit(ThreadPoolDemo::writeFile);
        System.out.println(filename.get());
    }
}
```

### Request Per Thread

ä¼ ç»Ÿ Spring MVC ä½¿ç”¨çš„æ˜¯ä¸€ä¸ª http è¯·æ±‚å¯¹åº”ä¸€ä¸ªçº¿ç¨‹çš„æ¨¡å‹

```java
@RestController
class NaiveCounterDemoController {
    // çº¿ç¨‹ä¸å®‰å…¨çš„ç¤ºèŒƒ
    private int counter = 0; // highlight-line

    @PostMapping("/inc")
    public void inc() {
        counter++; // highlight-line
    }

    @GetMapping("/get")
    public int get() {
        return counter;
    }
}
```

### Shared Mutable State

åœ¨ä¸Šé¢çš„ `NaiveCounterDemoController` ä¸­ï¼Œå¤šä¸ªçº¿ç¨‹å„è‡ªå¤„ç†è‡ªå·±çš„è¯·æ±‚ï¼Œå¹¶å‘ä¿®æ”¹ `counter` ä¼šé€ æˆé—®é¢˜ã€‚

å‡å¦‚æœ‰ 100 ä¸ªå¹¶å‘è¯·æ±‚å¢åŠ è®¡æ•°å™¨ï¼Œæœ€ç»ˆè®¡æ•°å™¨çš„ç»“æœå¯èƒ½å°äº 100ã€‚

åŸå› æ˜¯ `counter++` å¹¶éåŸå­çš„æ“ä½œï¼Œç›¸å½“äº `counter = counter + 1`ï¼Œå…ˆè¯»å–åå†™å…¥ã€‚

<figure>
  ![Race condition between two clients concurrently incrementing a counter](./counter-race.png)
  <figcaption>å¹¶å‘åŠ è®¡æ•°å™¨çš„é—®é¢˜å›¾è§£ï¼ˆå¼•è‡ª DDIAï¼‰</figcaption>
</figure>

è§£å†³æ–¹æ³•ï¼š
- æä¾›åŸå­æ“ä½œçš„çº¿ç¨‹å®‰å…¨çš„æ•°æ®æœºæ„ Thread-safe data structures: `AtomicInteger` ï¼ˆcounter åœºæ™¯é¦–é€‰ï¼‰
- äº’æ–¥é” Mutual exclusion
- çº¿ç¨‹éš”ç¦» Thread confinement

å‚è€ƒï¼š[Shared Mutable State and Concurrency in Kotlin](https://kotlinlang.org/docs/shared-mutable-state-and-concurrency.html)

## æ•°æ®åº“æŒä¹…åŒ–

- Raw SQL / Template Engine: MyBatis XML
- SQL DSL: JOOQ

```java
SELECT AUTHOR.FIRST_NAME, AUTHOR.LAST_NAME, COUNT(*)
FROM AUTHOR
JOIN BOOK ON AUTHOR.ID = BOOK.AUTHOR_ID
WHERE BOOK.LANGUAGE = 'DE'
AND BOOK.PUBLISHED > DATE '2008-01-01'
GROUP BY AUTHOR.FIRST_NAME, AUTHOR.LAST_NAME
HAVING COUNT(*) > 5
ORDER BY AUTHOR.LAST_NAME ASC NULLS FIRST
LIMIT 2
OFFSET 1
```

```java
create.select(AUTHOR.FIRST_NAME, AUTHOR.LAST_NAME, count())
      .from(AUTHOR)
      .join(BOOK).on(AUTHOR.ID.equal(BOOK.AUTHOR_ID))
      .where(BOOK.LANGUAGE.eq("DE"))
      .and(BOOK.PUBLISHED.gt(date("2008-01-01")))
      .groupBy(AUTHOR.FIRST_NAME, AUTHOR.LAST_NAME)
      .having(count().gt(5))
      .orderBy(AUTHOR.LAST_NAME.asc().nullsFirst())
      .limit(2)
      .offset(1)
```

- ORM: Hibernate / prisma.io
